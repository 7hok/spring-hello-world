<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <link href="https://fonts.googleapis.com/css?family=Hanuman&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="https://storage.googleapis.com/non-spec-apps/mio-icons/latest/outline.css">

    <th:block th:include="~{fragment/__bootstrap_link}"></th:block>
    <th:block th:include="~{navbar/__navbar_css}"></th:block>
    <style>
        .bg-color-two {
            background-color: #E5EAED;
        }
    </style>
</head>

<body>
    <div th:replace="~{navbar/__navbar}"></div>
    <div class="" layout:fragment="content"></div>
    <div th:replace="~{footer/__footer}"></div>
    <div sec:authorize="isAuthenticated()">
        <span id="isAuth" th:data-role="${#authentication.getPrincipal().getCurrentUser().getUserRole()}" class="d-none" th:text="${#authentication.getPrincipal().getCurrentUser().getLastNotificationClick()}">true</span>  
    </div>
    <th:block th:include="~{fragment/__javascript_link}"></th:block>
    <div class="" layout:fragment="content-js"></div>
    <script>

         
        // Document ready function
        $(function () {
            var button = $('#srch');
            var tooltip;

            button.focusout(function () {
                // tooltip.hide();
            });
            var l = 0;
            button.on("change paste keyup", function () {
                var name = $("#srch").val();
                if (l == 0) {

                    l = 1;
                    tooltip = new maTooltip(button, {
                        inline_style: 'max-width: none; border-radius: 4px; width: 250px; overflow: hidden',
                        full_visibility_duration: 999999999,
                        position: maTooltip.POSITION.BOTTOM,
                        static_message: `<div class="container-fluid p-0" onclick="window.location.href ='facebook.com'" style="background-color: white; overflow: hidden; color: black; border-radius: inherit; cursor: pointer;  margin-top: 16px">   
                        <div class="row p-0">
                                <div class="col-5 p-0">
                            <img style="width: 20px" src="/icon/isearch.png" alt=""><span>Search for:</span>
                        </div>
                        <div class="col-7 p-0" style="text-align: left;">
                         ${name}
                        </div>
                         </div> 
                         <div class="row">
                            <div class="col-4"><img style="width: 20px" src="https://upload.wikimedia.org/wikipedia/en/thumb/6/63/IMG_%28business%29.svg/1200px-IMG_%28business%29.svg.png" alt=""></div>
                            <div class="col-8">kladjfl;akdjfl;kjadl;kfj adlkfjl;akdf alkjsdf aksdjf akjf jk a dflkj akjdflkj;lkjlkajdflkjadf</div>
                        </div>
                        <div class="row">
                            <div class="col-4"><img style="width: 20px" src="https://upload.wikimedia.org/wikipedia/en/thumb/6/63/IMG_%28business%29.svg/1200px-IMG_%28business%29.svg.png" alt=""></div>
                            <div class="col-8">kladjfl;akdjfl;kjadl;kfj adlkfjl;akdf alkjsdf aksdjf akjf jk a dflkj akjdflkj;lkjlkajdflkjadf</div>
                        </div>
                        <div class="row">
                            <div class="col-4"><img style="width: 20px" src="https://upload.wikimedia.org/wikipedia/en/thumb/6/63/IMG_%28business%29.svg/1200px-IMG_%28business%29.svg.png" alt=""></div>
                            <div class="col-8">kladjfl;akdjfl;kjadl;kfj adlkfjl;akdf alkjsdf aksdjf akjf jk a dflkj akjdflkj;lkjlkajdflkjadf</div>
                        </div>
                         </div>`
                    });
                }
                else {

                    tooltip.DOM.$divContents
                        .html(`<div class="container-fluid p-0" onclick="window.location.href ='/facebook.com'" style="background-color: white; color: black; border-radius: inherit; cursor: pointer;  margin-top: 16px">   
                            <div class="row">
                                <div class="col-5 p-0 " >
                            <img style="width: 20px" src="/icon/isearch.png" alt=""><span>Search for:</span>
                        </div> 
                        <div class="col-7 p-0" style="text-align: left;">
                         ${name}
                        </div>
                         </div> 
                         <div class="row" style="border-bottom: 1px solid black;">
                            <div class="col-4"><img style="width: 20px" src="https://upload.wikimedia.org/wikipedia/en/thumb/6/63/IMG_%28business%29.svg/1200px-IMG_%28business%29.svg.png" alt=""></div>
                            <div class="col-8">kladjfl;akdjfl;kjadl;kfj adlkfjl;akdf alkjsdf aksdjf akjf jk a dflkj akjdflkj;lkjlkajdflkjadf</div>
                        </div>
                        <div class="row" style="border-bottom: 1px solid black;">
                            <div class="col-4"><img style="width: 20px" src="https://upload.wikimedia.org/wikipedia/en/thumb/6/63/IMG_%28business%29.svg/1200px-IMG_%28business%29.svg.png" alt=""></div>
                            <div class="col-8">kladjfl;akdjfl;kjadl;kfj adlkfjl;akdf alkjsdf aksdjf akjf jk a dflkj akjdflkj;lkjlkajdflkjadf</div>
                        </div>
                        <div class="row" style="border-bottom: 1px solid black;">
                            <div class="col-4"><img style="width: 20px" src="https://upload.wikimedia.org/wikipedia/en/thumb/6/63/IMG_%28business%29.svg/1200px-IMG_%28business%29.svg.png" alt=""></div>
                            <div class="col-8">kladjfl;akdjfl;kjadl;kfj adlkfjl;akdf alkjsdf aksdjf akjf jk a dflkj akjdflkj;lkjlkajdflkjadf</div>
                        </div>
                         </div>`)
                }

                tooltip.show();

            });
        });

        const updateLastReadIfClick = async () => {
            let json = null;
            try {
                let res = await fetch(`/user/update/lastread`, {
                    method: `POST`
                });
                json = await res.json();
                console.log(json)

            } catch (error) {
                console.log(error)
            }

            //findAllByOrderByIdDesc
            //api/contents/search/findAllByOrderByIdDesc?number=1&projection=ContentNotificationProjection

        }

        const updateLastReadIfClickShowContentList = async () => {
            // let res = await fetch(`api/contents/search/findAllByOrderByIdDesc?projection=ContentNotificationProjection`, {
            let res = await fetch(`/notification/get`, {
                method: `POST`
            });
            json = await res.json();
            console.log(json)
            if(json.type == 0){
               
                let contents = json.body;

                contents.forEach(content => {
                    $("#notification_div_body").append(convertJsonToNotificationList(content.id, content.category.name, content.timestamp))
                })
            }else if(json.type ==1 ){
                let comments = json.body;
                comments.forEach(comment => {
                    $("#notification_div_body").append(convertAdminJsonToNotificationList(comment.content.id,comment.text,  comment.timestamp))
                    // convertAdminJsonToNotificationList
                })
            }
            
        }
        var isClick = false;
        const getNotification = () => {
            let _last_read = $("#isAuth").text();
            if (_last_read == "") {
                /*unauthenticateed */
                console.log(`unauthenticateed`)
            } else {
                /*authenticated*/
                /*NOTE
                    ADMIN OR USER 

                    CHECK IN getAmountNotiFromApi
                */
                console.log(`authenticateed`)
                console.log(_last_read);
                let _unread_amount = getAmountNotiFromApi(_last_read)
                _unread_amount.then(amount => {
                    numberToNotificationAmount(amount)
                })

                $("#dLabel").on('click', function () {
                    /*NOTE ADMIN OR USER FETCH URI*/
                   if(isClick == false){
                        updateLastReadIfClickShowContentList()
                        updateLastReadIfClick();
                        isClick = true
                       $("#num_of_notification").text("")
                   }
                })
            }

        };
        /*NOTE URI PARAM :parameter for admin*/
        const getAmountNotiFromApi = async (datetime) => {
            let _role = $("#isAuth").attr("data-role");
            let _response = null;
            if(_role.includes("CLIENT")){
                _response=  await fetch(`/api/contents/search/findUnreadContentByDate?date=${datetime}`);
            }else if(_role.includes("ADMIN")){
                _response= await fetch(`/api/comments/search/findUnreadCommentByDate?date=${datetime}`);
            }
            
            const notification_json_amount = await _response.json();
            console.log(notification_json_amount)
            return notification_json_amount;
        }

        const numberToNotificationAmount = (amount) => {
            if (parseInt(amount) > 0) {
                $("#num_of_notification").text(amount)
            } else {

            }
        }
        const convertJsonToNotificationList = (article_id, category_name, time) => {
            return ` <a class="notifications-content" href="/detail/${article_id}">
                            <div class="notifications-item border-bottom">
                                <p class="item-title">New article has been posted in <b> ${category_name}</b></p>
                                <p class="item-info text-muted">${time}</p>
                            </div>

                </a>`
        }
        const convertAdminJsonToNotificationList = (article_id,comment_body,time) => {
            return ` <a class="notifications-content" href="${article_id}">
                            <div class="notifications-item border-bottom">
                                <p class="item-title">${comment_body}</b></p>
                                <p class="item-info text-muted">${time}</p>
                            </div>

                </a>`
        }
        getNotification()
    </script>
<script>

</script>

</body>

</html>