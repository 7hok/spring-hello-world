<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <link href="https://fonts.googleapis.com/css?family=Hanuman&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="https://storage.googleapis.com/non-spec-apps/mio-icons/latest/outline.css">

    <th:block th:include="~{fragment/__bootstrap_link}"></th:block>
    <th:block th:include="~{navbar/__navbar_css}"></th:block>
    <style>
        .bg-color-two {
            background-color: #E5EAED;
        }

        .outerDiv {
            display: inline-flex;
            /* height: 400px; */
            /* background-color: red; */
            /* color: white; */
        }

        .innerDiv:hover {
            text-decoration: underline;
        }

        .innerDiv {
            margin: auto 5px;
        }

        .mr:hover {
            text-decoration: underline;
            color: #96a0a5;
        }
    </style>
</head>

<body>
    <div th:replace="~{navbar/__navbar}"></div>
    <div class="" layout:fragment="content"></div>
    <div th:replace="~{footer/__footer}"></div>
    <div sec:authorize="isAuthenticated()">
        <span id="isAuth" class="d-none" th:text="${#authentication.getPrincipal().getCurrentUser().getLastNotificationClick()}">true</span>  
    </div>
    <th:block th:include="~{fragment/__javascript_link}"></th:block>
    <div class="" layout:fragment="content-js"></div>
    <script>


        // Document ready function
        $(function () {
            var button = $('#srch');
            var tooltip;

            var l = 0;

            button.on("  paste keyup", function () {

                var name = $("#srch").val();


                if (l == 0) {
                    l = 1;
                    tooltip = new maTooltip(button, {
                        inline_style: 'max-width: none; border-radius:8px; width: 270px; overflow: hidden; padding: 0pc;background-color: #fbfbfbfb;',
                        full_visibility_duration: 999999999,
                        position: maTooltip.POSITION.BOTTOM,
                        static_message: `<div id="srh" class="container-fluid p-0" style="    background-color: #fbfbfb; color: black; border-radius: inherit;   ">   
                            
                         </div>`
                    });
                }

                $.ajax({
                    url: `/api/contents/search/findByTitleContainingIgnoreCase?title=${name}&page=0&size=3&projection=ContentNotificationProjection`,
                    method: 'GET',
                    success: function (obj) {
                        tooltip.show();
                        $('.er').remove()
                        if (obj._embedded.contents.length == 0) {
                            $('.maTooltip-BOTTOM').remove()
                        }
                        var elem = "";
                        elem += `<div class ="row er p-2"  style="border-bottom: 1px  solid black;">
                                     <div class="col-6" style="font-size: 14px; text-align: left;">
                                        TITLE
                                     </div>
                                     <div class="col-6 mr" style="font-size: 14px; text-align: right; opacity: 0.8; cursor: pointer" onclick="window.location.href ='/search/${name}?type=2'">
                                         MORE
                                     </div>
                                 </div>`
                        for (i = 0; i < obj._embedded.contents.length; i++) {
                            elem += `
                        <div onclick="window.location.href ='/detail/${obj._embedded.contents[i].id}'" class="row er    mb-2 pt-2" style=" !important;  cursor: pointer" >
                            <div class="col-3 " ><img class=" rounded-circle z-depth-2 myButton point" style="width: 32px;margin-right: -20px; height: 32px" src=${obj._embedded.contents[i].thumbnail} alt=""></div>
                            <div class="col-9 pl-0 outerDiv" style="font-size: 14px; text-align: left; vertical-align: middle;"><div class ="innerDiv" style="line-height: 1.4;">${obj._embedded.contents[i].title}</div></div>
                        </div>
                        `

                        }

                        $("#srh").append(elem)

                    },
                    error: function (err) {

                        console.log(err);
                    }
                });


            });



            button.blur(function () {
                tooltip.hide();
            });

            $("#srchBody").click(function () {
                 $("#srch").val();
                 window.location.replace('/search/'+$("#srch").val()+'?type=1')
            });

        });

        const updateLastReadIfClick = async () => {
            let json = null;
            try {
                let res = await fetch(`/user/update/lastread`, {
                    method: `POST`
                });
                json = await res.json();
                console.log(json)

            } catch (error) {
                console.log(error)
            }



        }

        const updateLastReadIfClickShowContentList = async () => {
            let res = await fetch(`api/contents/search/findAllByOrderByIdDesc?number=&projection=ContentNotificationProjection`, {
                method: `GET`
            });
            json = await res.json();
            let = contents = json._embedded.contents;

            contents.forEach(content => {
                $("#notification_div_body").append(convertJsonToNotificationList(content.id, content.category.name, content.timestamp))
            })
        }
        const getNotification = () => {
            let _last_read = $("#isAuth").text();
            if (_last_read == "") {
                /*unauthenticateed */
                console.log(`unauthenticateed`)
            } else {
                /*authenticated*/
                console.log(`authenticateed`)
                console.log(_last_read);
                let _unread_amount = getAmountNotiFromApi(_last_read)
                _unread_amount.then(amount => {
                    numberToNotificationAmount(amount)
                })

                $("#dLabel").on('click', function () {
                    updateLastReadIfClickShowContentList()
                    updateLastReadIfClick()
                })
            }

        };

        const getAmountNotiFromApi = async (datetime) => {
            const response = await fetch(`/api/contents/search/findUnreadContentByDate?date=${datetime}`);
            const notification_json_amount = await response.json();
            console.log(notification_json_amount)
            return notification_json_amount;
        }

        const numberToNotificationAmount = (amount) => {
            if (parseInt(amount) > 0) {
                $("#num_of_notification").text(amount)
            } else {

            }
        }
        const convertJsonToNotificationList = (article_id, category_name, time) => {
            return ` <a class="notifications-content" href="/detail/${article_id}">
                            <div class="notifications-item border-bottom">
                                <p class="item-title">New article has been posted in <b> ${category_name}</b></p>
                                <p class="item-info text-muted">${time}</p>
                            </div>

                </a>`
        }
        getNotification()
    </script>
<script>

</script>

</body>

</html>